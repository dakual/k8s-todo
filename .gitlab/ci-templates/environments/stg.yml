variables:
  RUNNER: dev
  ENV: stg
  K8S_CLUSTER: ci-todo/app:minikube
  K8S_NAMESPACE: staging


stg:build:backend:
  variables:
    APP: frontend
  extends: 
    - .stg-rules
    - .build

stg:build:frontend:
  variables:
    APP: backend
  extends: 
    - .stg-rules
    - .build

stg:deploy:
  environment:
    name: ${ENV}/${CI_COMMIT_REF_SLUG}
    url: https://$CI_ENVIRONMENT_SLUG.example.com
    on_stop: stg:destroy
    deployment_tier: staging
    auto_stop_in: 1 minutes
  resource_group: ${ENV}/${CI_COMMIT_REF_SLUG}
  extends: 
    - .stg-rules
    - .deploy
  # needs:
  #   - stg:build:backend
  #   - stg:build:frontend

stg:destroy:
  environment:
    name: ${ENV}/${CI_COMMIT_REF_SLUG}
    action: stop
  extends: 
    - .stg-rules
    - .destroy
  needs:
    - stg:deploy
  # rules:
  #   - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH && $CI_COMMIT_TAG !~ /stable-.*/
  when: manual